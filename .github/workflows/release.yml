name: Release

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  create-release:
    name: Create Release Assets
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.11"
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run tests
      run: |
        python -m pytest tests/ -v
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY || 'test_key_for_ci' }}
    
    - name: Create source archive
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        if [ -z "$VERSION" ]; then
          VERSION=${{ github.event.inputs.version || 'dev' }}
        fi
        tar -czf sysml-agent-${VERSION}.tar.gz \
          --exclude='.git' \
          --exclude='__pycache__' \
          --exclude='*.pyc' \
          --exclude='.pytest_cache' \
          --exclude='.cache' \
          --exclude='data/pdfs/*.pdf' \
          --exclude='venv' \
          --exclude='.venv' \
          src/ config/ utils/ tests/ requirements.txt README.md SETUP.md .gitignore
    
    - name: Upload release artifact
      uses: actions/upload-artifact@v4
      with:
        name: release-artifacts
        path: |
          sysml-agent-*.tar.gz
        retention-days: 30

